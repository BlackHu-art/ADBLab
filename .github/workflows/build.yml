name: Build EXE

on:
  workflow_dispatch:
  push:
    branches: ["master"]

permissions: write-all

env:
  APP_NAME: ADBLab
  VERSION: v2.0.${{ github.run_number }}

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [x86, x64]

    outputs:
      artifact_name: ${{ steps.setname.outputs.artifact_name }}

    steps:
      # 1. æ‹‰å–ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: ${{ matrix.arch }}

      # 3. pip ç¼“å­˜
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. æ¸…ç†æ„å»ºç›®å½•
      - name: Clean environment
        shell: powershell
        run: |
          Remove-Item -Recurse -Force build, dist, *.spec -ErrorAction SilentlyContinue

      # 5. å®‰è£…ä¾èµ–
      - name: Install dependencies
        shell: powershell
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt

      # 6. PyInstaller æ‰“åŒ…
      - name: Build EXE
        shell: powershell
        run: |
          python -m PyInstaller `
            --name "${{ env.APP_NAME }}-${{ matrix.arch }}-${{ env.VERSION }}" `
            --onefile `
            --windowed `
            --icon icon.ico `
            --hidden-import pywin32 `
            entry.py

      # 7. åˆ›å»º ZIP åŒ…
      - name: Create ZIP Package
        shell: powershell
        run: |
          $zipFile = "${{ env.APP_NAME }}-${{ matrix.arch }}-${{ env.VERSION }}.zip"
          Compress-Archive -Path dist\*.exe -DestinationPath $zipFile

      # 8. è®¾ç½® artifact åå­—
      - name: Set artifact name
        id: setname
        run: echo "artifact_name=${{ env.APP_NAME }}-${{ matrix.arch }}-${{ env.VERSION }}" >> $GITHUB_OUTPUT

      # 9. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setname.outputs.artifact_name }}
          path: |
            dist/*.exe
            *.zip

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ä¸‹è½½æ‰€æœ‰ artifactsï¼ˆx86 + x64ï¼‰
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 3. è‡ªåŠ¨ç”Ÿæˆ CHANGELOG
      - name: Generate Changelog
        id: changelog
        run: |
          LOG=$(git log -10 --pretty=format:"- %s (%an)")
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4. åˆ›å»º Release
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: "Release ${{ env.VERSION }}"
          body: |
            ## ğŸš€ ADBLab Release ${{ env.VERSION }}

            ### ğŸ”¥ æ›´æ–°å†…å®¹ (è‡ªåŠ¨ç”Ÿæˆ)
            ${{ steps.changelog.outputs.log }}

            ### ğŸ§Š åŒ…å«ä»¥ä¸‹æ„å»ºï¼š
            - x64
            - x86

            ### ğŸ“¦ æ–‡ä»¶å·²é™„åŠ åœ¨æœ¬æ¬¡å‘å¸ƒä¸­ã€‚
          files: artifacts/**/*
